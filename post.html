<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post - Liu Lifu's Blog</title>
    <link rel="stylesheet" href="css/themes/theme-base.css">
    <link rel="stylesheet" href="css/themes/theme-cyberpunk.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Markdown -->
    <script src="js/showdown.min.js"></script>
    <!-- Scripts -->
    <script src="js/config.js"></script>
    <meta name="description" content="Article page">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body class="theme-cyberpunk">
    <header>
        <nav class="site-nav">
            <div class="nav-links">
                <a href="index.html" class="neon-text">Home</a>
                <a href="tags.html" class="neon-text">Tags</a>
            </div>
            <div class="search-container">
                <input type="text" id="ai-search" placeholder="AI-powered search...">
                <div id="search-results" class="search-results"></div>
            </div>
        </nav>
    </header>

    <main class="post-container">
        <article class="post-content">
            <div id="post" class="markdown-content">
                <!-- Post content will be loaded here -->
            </div>
            <div id="related-posts" class="related-posts">
                <h3>Related Posts</h3>
                <!-- Related posts loaded via AI -->
            </div>
            <a href="index.html" class="back-button">Back to List</a>
        </article>
    </main>

    <div id="ai-assistant" class="ai-assistant">
        <div class="ai-assistant-header">
            <span>AI Assistant</span>
            <button id="toggle-ai">Toggle AI</button>
        </div>
        <div class="ai-assistant-content">
            <div id="ai-messages"></div>
            <input type="text" id="ai-input" placeholder="Ask about this article...">
        </div>
    </div>

    <footer>
        <p>&copy; <span id="current-year"></span> Liu Lifu. All rights reserved.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize theme manager
            initializeThemeManager();
        });

        // Show loading animation
        function showLoading() {
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.innerHTML = '<div class="loading-spinner"></div>';
            document.body.appendChild(overlay);
        }

        function hideLoading() {
            const overlay = document.querySelector('.loading-overlay');
            if (overlay) {
                overlay.addEventListener('transitionend', () => overlay.remove());
                overlay.style.opacity = '0';
            }
        }

        // Load and display post content
        async function loadPost(filename) {
            showLoading();
            try {
                // Get post file from URL
                const urlParams = new URLSearchParams(window.location.search);
                const postFile = urlParams.get('post');
                if (!postFile) {
                    throw new Error('No post specified');
                }

                // Load post content
                const response = await fetch(`posts/${postFile}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const markdown = await response.text();
                
                // Convert markdown to HTML
                const converter = new showdown.Converter(config.markdown.converter);
                const html = converter.makeHtml(markdown);
                
                // Display content
                const postElement = document.getElementById('post');
                postElement.innerHTML = html;
                
                // Add syntax highlighting
                if (window.Prism) {
                    Prism.highlightAll();
                }
                
                // Update page title
                updatePageTitle(postFile);
                
            } catch (error) {
                console.error('Error loading post:', error);
                document.getElementById('post').innerHTML = `<div class="error-message">
                    <h2>Error Loading Post</h2>
                    <p>${error.message}</p>
                    <a href="index.html" class="back-link">Return to Home</a>
                </div>`;
            } finally {
                hideLoading();
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const postFile = urlParams.get('post');
            if (postFile) {
                loadPost(postFile);
            }
        });

        // Update page title based on metadata
        async function updatePageTitle(filename) {
            try {
                const response = await fetch('metadata.json');
                const metadata = await response.json();
                const postInfo = metadata[filename];
                
                if (postInfo && postInfo.title) {
                    document.title = `${postInfo.title} - Liu Lifu's Blog`;
                    document.getElementById('post-title').textContent = postInfo.title;
                }
            } catch (error) {
                console.error('Error loading metadata:', error);
            }
        }

        // Initialize AI features
        window.addEventListener('DOMContentLoaded', async () => {
            await AIFeatures.init();
            
            // Setup AI search
            const searchInput = document.getElementById('ai-search');
            const searchResults = document.getElementById('search-results');
            
            searchInput.addEventListener('input', async (e) => {
                if (e.target.value.length < 2) {
                    searchResults.style.display = 'none';
                    return;
                }
                
                const results = await AIFeatures.searchContent(e.target.value);
                displaySearchResults(results);
            });
        });

        function displaySearchResults(results) {
            const searchResults = document.getElementById('search-results');
            searchResults.innerHTML = '';
            
            if (results.length === 0) {
                searchResults.style.display = 'none';
                return;
            }

            results.forEach(result => {
                const div = document.createElement('div');
                div.className = 'search-result';
                div.innerHTML = `
                    <a href="post.html?post=${result.id}">
                        <h4>${result.title}</h4>
                        <p>${result.excerpt}</p>
                    </a>
                `;
                searchResults.appendChild(div);
            });
            
            searchResults.style.display = 'block';
        }

        function displayRelatedPosts(posts) {
            const container = document.getElementById('related-posts');
            if (posts.length === 0) {
                container.style.display = 'none';
                return;
            }

            const html = posts.map(post => `
                <div class="related-post">
                    <a href="post.html?post=${post.id}">
                        <h4>${post.title}</h4>
                        <p>${post.excerpt}</p>
                    </a>
                </div>
            `).join('');

            container.innerHTML = `<h3>Related Posts</h3>${html}`;
            container.style.display = 'block';
        }

        // Set current year
        document.getElementById('current-year').textContent = new Date().getFullYear();
    </script>
</body>
</html>
