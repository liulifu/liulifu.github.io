<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading... - Liu Lifu's Blog</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="js/showdown.min.js"></script>
    <script src="js/ai-features.js"></script>
    <script src="config.js"></script>
    <meta name="description" content="Article page">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <header>
        <nav class="site-nav">
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="tags.html">Tags</a>
                <a href="https://liulifu.github.io/post.html?post=2024-12-05-about.md">About</a>
            </div>
            <div class="search-container">
                <input type="text" id="ai-search" placeholder="AI-powered search...">
                <div id="search-results" class="search-results"></div>
            </div>
        </nav>
    </header>

    <main class="content">
        <article>
            <div class="post-header">
                <h1 class="post-title" id="post-title">Loading...</h1>
                <div class="post-meta">
                    <span id="post-date"></span>
                    <span id="post-categories"></span>
                    <span id="reading-time"></span>
                </div>
            </div>
            <div class="post-content" id="post-content">
                <!-- Content loaded via JavaScript -->
            </div>
            <div id="related-posts" class="related-posts">
                <h3>Related Posts</h3>
                <!-- Related posts loaded via AI -->
            </div>
            <a href="index.html" class="back-button">返回列表</a>
        </article>
    </main>

    <div id="ai-assistant" class="ai-assistant">
        <div class="ai-assistant-header">
            <span>AI Assistant</span>
            <button id="toggle-ai">Toggle AI</button>
        </div>
        <div class="ai-assistant-content">
            <div id="ai-messages"></div>
            <input type="text" id="ai-input" placeholder="Ask about this article...">
        </div>
    </div>

    <footer>
        <p>&copy; <span id="current-year"></span> Liu Lifu. All rights reserved.</p>
    </footer>

    <script>
        // 获取文章文件名
        const urlParams = new URLSearchParams(window.location.search);
        const postFile = urlParams.get('post');

        // 加载文章内容和元数据
        async function loadPost() {
            if (!postFile) {
                showError('No post specified');
                return;
            }

            try {
                // 加载文章元数据
                const metadata = await siteConfig.loadMetadata();
                const post = metadata.posts[postFile];
                
                if (!post) {
                    showError('Post not found in metadata');
                    return;
                }

                // 检查内容类型
                if (post.type === 'tool') {
                    // 如果是工具类型，重定向到工具页面
                    window.location.href = post.url;
                    return;
                }

                // 加载文章内容（仅对article类型）
                const postContent = await siteConfig.loadMarkdown('posts/' + postFile);
                displayPost(postContent, post);
            } catch (error) {
                console.error('Error loading post:', error);
                showError('Error loading post');
            }
        }

        function showError(message) {
            document.getElementById('post-title').textContent = 'Error';
            document.getElementById('post-content').innerHTML = `<p>${message}</p>`;
        }

        async function displayPost(markdown, metadata) {
            // Set title
            const title = metadata.title || 'Untitled';
            document.title = `${title} - Liu Lifu's Blog`;
            document.getElementById('post-title').textContent = title;

            // Set date
            if (metadata.date) {
                const date = new Date(metadata.date);
                document.getElementById('post-date').textContent = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }

            // Convert markdown to HTML
            const converter = new showdown.Converter({
                tables: true,
                strikethrough: true,
                tasklists: true,
                ghCodeBlocks: true,
                emoji: true
            });
            const html = converter.makeHtml(markdown);
            document.getElementById('post-content').innerHTML = html;

            // Calculate and display reading time
            const words = markdown.trim().split(/\s+/).length;
            const readingTime = Math.ceil(words / 200); // Assuming 200 words per minute
            document.getElementById('reading-time').textContent = `${readingTime} min read`;

            // Load related posts
            const relatedPosts = await AIFeatures.getRelatedPosts(postFile);
            displayRelatedPosts(relatedPosts);

            // Initialize syntax highlighting
            if (window.Prism) {
                Prism.highlightAll();
            }
        }

        // Initialize AI features
        window.addEventListener('DOMContentLoaded', async () => {
            await AIFeatures.init();
            
            // Setup AI search
            const searchInput = document.getElementById('ai-search');
            const searchResults = document.getElementById('search-results');
            
            searchInput.addEventListener('input', async (e) => {
                if (e.target.value.length < 2) {
                    searchResults.style.display = 'none';
                    return;
                }
                
                const results = await AIFeatures.searchContent(e.target.value);
                displaySearchResults(results);
            });
        });

        function displaySearchResults(results) {
            const searchResults = document.getElementById('search-results');
            searchResults.innerHTML = '';
            
            if (results.length === 0) {
                searchResults.style.display = 'none';
                return;
            }

            results.forEach(result => {
                const div = document.createElement('div');
                div.className = 'search-result';
                div.innerHTML = `
                    <a href="post.html?post=${result.id}">
                        <h4>${result.title}</h4>
                        <p>${result.excerpt}</p>
                    </a>
                `;
                searchResults.appendChild(div);
            });
            
            searchResults.style.display = 'block';
        }

        function displayRelatedPosts(posts) {
            const container = document.getElementById('related-posts');
            if (posts.length === 0) {
                container.style.display = 'none';
                return;
            }

            const html = posts.map(post => `
                <div class="related-post">
                    <a href="post.html?post=${post.id}">
                        <h4>${post.title}</h4>
                        <p>${post.excerpt}</p>
                    </a>
                </div>
            `).join('');

            container.innerHTML = `<h3>Related Posts</h3>${html}`;
            container.style.display = 'block';
        }

        // Set current year
        document.getElementById('current-year').textContent = new Date().getFullYear();

        // Load post
        loadPost();
    </script>
</body>
</html>
